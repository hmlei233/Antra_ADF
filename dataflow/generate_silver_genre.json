{
	"name": "generate_silver_genre",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "bronzemovie",
						"type": "DatasetReference"
					},
					"name": "source1"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "silvergenre",
						"type": "DatasetReference"
					},
					"name": "genresink"
				},
				{
					"name": "moviegenresink"
				},
				{
					"dataset": {
						"referenceName": "silver_language",
						"type": "DatasetReference"
					},
					"name": "languagesink"
				}
			],
			"transformations": [
				{
					"name": "flatten1"
				},
				{
					"name": "select1"
				},
				{
					"name": "aggregate1"
				},
				{
					"name": "select2"
				},
				{
					"name": "select3"
				},
				{
					"name": "window1"
				},
				{
					"name": "aggregate2"
				},
				{
					"name": "join1"
				},
				{
					"name": "select4"
				},
				{
					"name": "select5"
				},
				{
					"name": "filter1"
				}
			],
			"scriptLines": [
				"source(output(",
				"          movie as (Id as integer, Title as string, Overview as string, Tagline as string, Budget as double, Revenue as double, ImdbUrl as string, TmdbUrl as string, PosterUrl as string, BackdropUrl as string, OriginalLanguage as string, ReleaseDate as string, RunTime as integer, Price as double, CreatedDate as string, UpdatedDate as string, UpdatedBy as string, CreatedBy as string, genres as (id as integer, name as string)[]),",
				"          datasource as string,",
				"          ingesttime as timestamp,",
				"          ingestdate as date,",
				"          status as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'parquet') ~> source1",
				"select5 foldDown(unroll(genres),",
				"     mapColumn(",
				"          movie_id = Id,",
				"          genre_id = genres.id,",
				"          genre_name = genres.name",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: true) ~> flatten1",
				"flatten1 select(mapColumn(",
				"          genre_id,",
				"          genre_name",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"select1 aggregate(groupBy(genre_id),",
				"     genre_name = max(genre_name)) ~> aggregate1",
				"flatten1 select(mapColumn(",
				"          movie_id,",
				"          genre_id",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select2",
				"select5 select(mapColumn(",
				"          OriginalLanguageName = OriginalLanguage",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select3",
				"select3 window(over(OriginalLanguageName),",
				"     asc(OriginalLanguageName, true),",
				"     OriginalLanguageId = denseRank()) ~> window1",
				"window1 aggregate(groupBy(OriginalLanguageId),",
				"     OriginalLanguageName = max(OriginalLanguageName)) ~> aggregate2",
				"select5, aggregate2 join(OriginalLanguage == OriginalLanguageName,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> join1",
				"join1 select(mapColumn(",
				"          Id,",
				"          Title,",
				"          Overview,",
				"          Tagline,",
				"          Budget,",
				"          Revenue,",
				"          ImdbUrl,",
				"          TmdbUrl,",
				"          PosterUrl,",
				"          BackdropUrl,",
				"          OriginalLanguage = OriginalLanguageId,",
				"          ReleaseDate,",
				"          RunTime,",
				"          Price,",
				"          CreatedDate,",
				"          UpdatedDate,",
				"          UpdatedBy,",
				"          CreatedBy,",
				"          movie = movie",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select4",
				"filter1 select(mapColumn(",
				"          Id = movie.Id,",
				"          Title = movie.Title,",
				"          Overview = movie.Overview,",
				"          Tagline = movie.Tagline,",
				"          Budget = movie.Budget,",
				"          Revenue = movie.Revenue,",
				"          ImdbUrl = movie.ImdbUrl,",
				"          TmdbUrl = movie.TmdbUrl,",
				"          PosterUrl = movie.PosterUrl,",
				"          BackdropUrl = movie.BackdropUrl,",
				"          OriginalLanguage = movie.OriginalLanguage,",
				"          ReleaseDate = movie.ReleaseDate,",
				"          RunTime = movie.RunTime,",
				"          Price = movie.Price,",
				"          CreatedDate = movie.CreatedDate,",
				"          UpdatedDate = movie.UpdatedDate,",
				"          UpdatedBy = movie.UpdatedBy,",
				"          CreatedBy = movie.CreatedBy,",
				"          genres = movie.genres,",
				"          movie",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select5",
				"source1 filter(status == \"new\") ~> filter1",
				"aggregate1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'parquet',",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> genresink",
				"select2 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> moviegenresink",
				"aggregate2 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'parquet',",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> languagesink"
			]
		}
	}
}